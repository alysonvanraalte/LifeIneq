---
title: "Introduction to LifeIneq"
author: "Alyson van Raalte, Tim Riffe"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: REFERENCES.bib
vignette: >
  %\VignetteIndexEntry{Introduction to LifeIneq}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
header-includes:
- \usepackage{amsmath}
- \usepackage{amssymb}
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6, 
  fig.height = 6,
  fig.align = "center"
)
```

## Introduction

How unequal are ages at death spread within a population? There are many indices that can be calculated from a life table to answer this question, all generally going under the umbrella terms *lifespan inequality*, *lifespan variation*, *age-at-death variation*, *compression of mortality*, or *rectangularization of the survival curve*.

In this R package we have implemented code to calculate such indices from life tables. In what follows, we will go through how to use the package with example Canadian and Hungarian life table data from the Human Mortality Database [@barbieri2015]. But first, we start with a more general discussion on the lifespan inequality indices themselves. This discussion is brief. Good overviews on the mathematical properties of the indices and how they differ empirically can be found in [@wilmoth1999; @shkolnikov2003;  @vanraalte2013; @wrycza2015]. 




## Choosing a measure of lifespan inequality

Variation is a broad concept. Since it is often used to make judgements on the inequality of a distribution, numerous indices have been developed differing in their mathematical properties and sensitivities to different parts of the distribution. As Paul @Allison1978 (p. 865) noted,*“The choice of an inequality measure is properly regarded as a choice among alternative definitions of inequality rather than a choice among alternative ways of measuring a single theoretical construct.”*
Here we outline some of the more important considerations.

### Absolute versus relative inequality
A number of indices of lifespan variation are used to measure absolute and relative inequality in ages at death. Absolute measures are scale invariant, meaning that their values do not change when the same life years are added to everyone’s lifespan (i.e. the distribution is shifted to higher ages). Relative measures are translation invariant, meaning that they do not change when adding the same proportion of life to everyone’s lifespan. If an age-at-death distribution shifts to the right with increasing life expectancy, absolute inequality stays unchanged, but relative inequality declines. 

Absolute measures are generally measured in years, making them easier to interpret, but relative measures have their own advantages. Relative measures are preferred by biologists to compare species with very different life histories and life expectancies [@eakin1995; @baudisch2011; @colchero2016]. This is less of an issue in comparing contemporary human populations, either across or within countries. In the end, we feel that the choice between measuring absolute versus relative inequality is a normative one. If there is no inherent reason for preferring absolute or relative inequality, it is good practice to present both. 


### Attainment versus shortfall distribution
Relative measures of lifespan inequality have an additional specification: whether the inequality is relative to an average achieved age at death (e.g. from an attainment distribution) or to a remaining life expectancy (e.g. from a shortfall distribution). When following a cohort from birth, the means of the two distributions are the same---average age at death equals life expectancy at birth.
Often though, we want to measure the lifespan inequality of populations or groups based on a conditional age-at-death distribution—in other words, a distribution with a starting age greater than zero, where the lifespan inequality is calculated conditional on surviving to that starting age. As an example, completed education can only be defined from early adulthood. 
In such cases, should inequality be made relative to the average age at death, conditional upon survival to age $x$, or to the average remaining life expectancy at age $x$? So far, few researchers have paid attention to this difference. There are plenty of studies based on conditional distributions, including our own, but no reflection on how the choice of denominator (the distribution type) could impact the result. 
Indeed, the choice of conditional distribution seems to depend on the measure used. The coefficient of variation, the Theil Index, and the Mean Log Deviation are generally calculated from the achieved age at death distribution [@Hakkert1987; @vanraalte2012; @Permanyer2019; @Shkolnikov2010; @Nemeth2014; @Permanyer2019; @Seaman2020]. The Keyfitz-Leser life table entropy measure has been calculated from shortfall distributions [@Bramajo2022]. The Gini coefficient, when calculated from the Kendall and Stuart definition, has used attained ages [@Permanyer2019], while when calculated based on the Hanada formulation has used remaining life expectancy [@Shkolnikov2003]. 
Is there any reason to prefer one concept over the other? We ourselves cannot decide, and prefer to leave this debate to play out in the literature. All of these measures can be calculated in both ways, and the LifeIneq package has added an argument to relative measures to make this choice explicit. In the empirical examples of section XX, we demonstrate how important this distinction is.

## Built-in indices of variation
Currently, the `LifeIneq` package contains the following indices of lifespan inequality: 
- ***AID*** the Absolute Inter-individual Difference, also known as the absolute Gini Coefficient
- ***COV*** the Coefficient of Variation 
- ***cp*** Kannisto's *C* measures---the shortest distance between two ages containing $p$ percent of the life table cohort's deaths. 
- ***$e^{\dagger}$*** the life disparity, or average life years lost due to death
- ***H*** the Leser-Keyfitz life table index, also called the life table entropy, which is more properly described as the elasticity of life expectancy to proportional change in mortality. It is also the relative mortality equivalent of $e^{\dagger}$ [@vaupel1986, @goldman1986] 
- ***IQR*** the interquartile range of the age-at-death distribution, e.g. the difference between the 75th and 25th percentile of survival ages in the life table cohort
- ***MAD*** the mean absolute deviation in lifetable ages at death. This may be with respect to either the mean or median age at death
- ***MLD*** the mean log deviation of survival
- ***quantile*** quantiles of survivorship
- ***SD*** the standard deviation in ages at death
- ***T*** the Theil index of survival
- ***V*** the variance in ages at death

`Table 1` shows the formula we implemented to calculate the measure. All formulas are given in the discrete form which are easier to work with from life tables, with variables defined below the table. Since mortality is a continuous process, different assumptions made on how to discretize survival have resulted in several different formulations, not all of which are completely equivalent (although they are close). The column `Type` refers to whether the index measures absolute or relative inequality in ages at death. 

|Index|Formula|Type|
|------|-------|----|
|AID|



We use the following notation, based on a single-age life table. The first few columns use the HMD life table notation, the last two are extra columns necessary for the calculations of some lifespan inequality indices, and tend not to be well standardized across the literature. We have dropped the ‘n’ subscript since we suggest users to calculate indices from single-year of age life tables, however all formulas could be equally calculate using age-intervals $[x,x+n)$ with some loss of accuracy:

+ $x$ is age 
+ $m_x$ is the death rate in the interval $[x,x+1)$
+ $q_x$ is the probability of dying in the interval $[x,x+1)$
+ $a_x$ is the number of person-years lived in the interval $[x,x+1)$
+ $\ell_x$ is the number of survivors at exact age $x$
+ $d_x$ is the number of deaths in the interval $[x,x+1)$
+ $L_x$ is the number of person-years in the interval $[x,x+1)$
+ $T_x$ is the number of person-years above age $x$
+ $e_x$ is the remaining life expectancy above age $x$
+ ${\Eta}_x$ is the average age at death, conditional on survival to age $x$ (equivalent to $e_x$ + $x$)
+ ${\Alpa}_x$ is the average age at death in the interval $[x,x+1)$ (equivalent to $a_x$ + $x$)


## Installing and loading the package

When using the package for the first time, you need to install the package from CRAN. 

```{r eval=F}
install.packages("LifeIneq")
```


On subsequent uses, you can start from here, where we first load the package into our workspace.


```{r}
#library(LifeIneq)
```

We recommend to use data in a single-age format, although the package can handle abridged-data formats as well. We also recommend closing out a life table at an age with few deaths. Lifespan variation is far more sensitive to mortality at higher ages than life expectancy [@vanraalte2013], and assumptions on the mortality hazard in the open-ended age interval can make a considerable difference when this age is close to the modal age at death. 

If your data have a lower upper age bound, consider extrapolation methods, for instance a parametric Kannisto model (implemented in `MortalityLaws::MortalityLaw`). If your data are abridged, consider first smoothing over age, and calculating a life table by single year of age (for instance by smoothing with a pclm model in the package `ungroup` or with a penalized B-spline approach in the package `MortalitySmooth`).
 
Installed in the package is the Canadian female 1x1 period life table from 2016, taken from the HMD, which we will use for our examples.  The HMD data is freely available after registration. The `HMDHFDPlus` R package works well to read in the data.

Here are the first few lines of the life table. It is in the classic life table form, with data by single year of age up to an open-ended age interval of 110+. To make the data easier to handle, the `Age` column is an integer referring to the starting age. The column `OpenInterval` is an indicator column which is `FALSE` for ages 0 to 109, and `TRUE` for the open-ended age interval 110+. This handy life table structure comes from the `HMDHFDPlus` R package.


```{r, echo=F}
#head(LifeIneq::LT)
```

## Calculating lifespan inequality




## Minor issues to be aware of

Some of the indices will return NaNs at the very oldest ages, beyond around the last one-tenth of a percent of deaths. This is usually owing to the package taking integer counts, with $d_x$ or $\ell_x$ counts being zero.   




## Empirical examples


```{r eval=F}
library(LifeIneq)
library(dplyr)
library(ggplot2)

LTs <- read.csv("HUNmltper_1x1.csv", head=T)

ineq <- LTs %>%
            filter(Age==30 | Age==65) %>%
            group_by(Age,Year) %>%
            mutate(COV_AD == ineq(age=Age,dx,lx,ex,ax,),
                   COV_RL)

# change to tidy code-----


LT30 <- subset(LTs,Age>=30)
LT65 <- subset(LTs,Age>=65)

Years <- unique(LTs$Year)

COV30_AAD <- COV65_AAD <- COV30_ex <- COV65_ex <- rep(NA,length(Years))

for(i in 1:length(Years)){
  # coefficient of variation in conditional achieved ages at death
COV30_AAD[i] <- ineq_sd(age=30:110,
                  dx=subset(LT30,Year==Years[i])$dx,
                  lx=subset(LT30,Year==Years[i])$lx,
                  ex=subset(LT30,Year==Years[i])$ex,
                  ax=subset(LT30,Year==Years[i])$ax)[1] / (subset(LT30,Year==Years[i])$ex[1]+30)[1]

COV65_AAD[i] <- ineq_sd(age=65:110,
                  dx=subset(LT65,Year==Years[i])$dx,
                  lx=subset(LT65,Year==Years[i])$lx,
                  ex=subset(LT65,Year==Years[i])$ex,
                  ax=subset(LT65,Year==Years[i])$ax)[1] / (subset(LT65,Year==Years[i])$ex[1]+65)[1]

# coefficient of variation in conditional remaining life expectancy
COV30_ex[i] <- ineq_sd(age=30:110,
                  dx=subset(LT30,Year==Years[i])$dx,
                  lx=subset(LT30,Year==Years[i])$lx,
                  ex=subset(LT30,Year==Years[i])$ex,
                  ax=subset(LT30,Year==Years[i])$ax)[1] / (subset(LT30,Year==Years[i])$ex[1])[1]

COV65_ex[i] <- ineq_sd(age=65:110,
                  dx=subset(LT65,Year==Years[i])$dx,
                  lx=subset(LT65,Year==Years[i])$lx,
                  ex=subset(LT65,Year==Years[i])$ex,
                  ax=subset(LT65,Year==Years[i])$ax)[1] / (subset(LT65,Year==Years[i])$ex[1])[1]
}

# plotting

par(mfrow=c(1,3))
plot(x=Years,y=COV30_AAD/COV30_AAD[1],t="l",lwd=2,col="darkorange",ylim=c(0.8,1.2))
lines(x=Years,y=COV30_ex/COV30_ex[1],lwd=2,col="navyblue")

plot(x=Years,y=COV65_AAD/COV65_AAD[1],t="l",lwd=2,col="darkorange",ylim=c(0.8,1.2))
lines(x=Years,y=COV65_ex/COV65_ex[1],lwd=2,col="navyblue")

plot(x=Years,y=subset(LT30,Age==30)$ex/subset(LT30,Age==30)$ex[1],t="l",lwd=2,col="darkred",ylim=c(0.8,1.2))
lines(x=Years,y=subset(LT30,Age==65)$ex/subset(LT30,Age==65)$ex[1],lwd=2,col="cornflowerblue")

```



## References




